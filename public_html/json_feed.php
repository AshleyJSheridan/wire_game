<?php

$pdo = new PDO("mysql:dbname=wire_game;host=localhost", 'root', '', array(PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES 'UTF8'"));

session_start();
$negative_threshold = 5;	// determines how much in terms of % that a movement can be recognised as going backwards legitimately

$markers = array(
0.25=>'22.1,55.9', 
0.5=>'21.8,55.2', 
0.75=>'21.4,54.6', 
1=>'21,53.9', 
1.25=>'20.6,53.3', 
1.5=>'20.3,52.7', 
1.75=>'19.9,52', 
2=>'19.5,51.4', 
2.25=>'19.1,50.7', 
2.5=>'18.8,50.1', 
2.75=>'18.4,49.4', 
3=>'18,48.8', 
3.25=>'17.6,48.2', 
3.5=>'17.3,47.5', 
3.75=>'16.9,46.9', 
4=>'16.5,46.2', 
4.25=>'16.1,45.6', 
4.5=>'15.8,45', 
4.75=>'15.4,44.3', 
5=>'15,43.7', 
5.25=>'14.6,43', 
5.5=>'14.3,42.4', 
5.75=>'13.9,41.8', 
6=>'13.2,41.7', 
6.25=>'12.4,41.6', 
6.5=>'11.7,41.5', 
6.75=>'11,41.5', 
7=>'10.3,41.4', 
7.25=>'9.6,41.3', 
7.5=>'8.9,41.3', 
7.75=>'8.7,40.6', 
8=>'8.5,39.9', 
8.25=>'8.3,39.2', 
8.5=>'8.1,38.5', 
8.75=>'7.9,37.8', 
9=>'8.6,37.7', 
9.25=>'9.4,37.7', 
9.5=>'10.1,37.6', 
9.75=>'10.9,37.6', 
10=>'11.6,37.5', 
10.25=>'11.3,36.8', 
10.5=>'11,36.2', 
10.75=>'10.7,35.5', 
11=>'10.5,34.8', 
11.25=>'10.2,34.2', 
11.5=>'9.9,33.5', 
11.75=>'9.6,32.8', 
12=>'9.3,32.2', 
12.25=>'9,31.5', 
12.5=>'8.7,30.8', 
12.75=>'8.4,30.1', 
13=>'8.1,29.5', 
13.25=>'7.8,28.8', 
13.5=>'7.5,28.1', 
13.75=>'7.2,27.5', 
14=>'6.9,26.8', 
14.25=>'6.6,26.1', 
14.5=>'6.3,25.5', 
14.75=>'6,24.8', 
15=>'5.8,24.1', 
15.25=>'6.5,24.1', 
15.5=>'7.2,24.1', 
15.75=>'7.9,24.1', 
16=>'8.7,24', 
16.25=>'9.4,24', 
16.5=>'10.1,24', 
16.75=>'10.4,24.7', 
17=>'10.7,25.4', 
17.25=>'11,26.1', 
17.5=>'11.3,26.8', 
17.75=>'11.6,27.4', 
18=>'11.9,28.1', 
18.25=>'12.2,28.8', 
18.5=>'12.5,29.5', 
18.75=>'12.8,30.2', 
19=>'13.1,30.9', 
19.25=>'13.4,31.6', 
19.5=>'13.7,32.3', 
19.75=>'14,32.9', 
20=>'14.3,33.6', 
20.25=>'14.6,34.3', 
20.5=>'14.9,35', 
20.75=>'15.2,35.7', 
21=>'15.5,36.4', 
21.25=>'15.8,37.1', 
21.5=>'16.1,37.8', 
21.75=>'16.8,37.8', 
22=>'17.6,37.9', 
22.25=>'18.3,37.9', 
22.5=>'19,38', 
22.75=>'19.7,38', 
23=>'20.4,38.1', 
23.25=>'21.1,38.1', 
23.5=>'21.9,38.2', 
23.75=>'22.6,38.3', 
24=>'23.3,38.3', 
24.25=>'24,38.4', 
24.5=>'24.3,39.1', 
24.75=>'24.5,39.8', 
25=>'24.8,40.5', 
25.25=>'25,41.2', 
25.5=>'25.3,41.9', 
25.75=>'24.5,41.9', 
26=>'23.7,41.9', 
26.25=>'23,41.9', 
26.5=>'22.2,41.9', 
26.75=>'21.4,41.9', 
27=>'20.7,41.9', 
27.25=>'19.9,41.9', 
27.5=>'19.1,41.9', 
27.75=>'18.4,41.9', 
28=>'18.7,42.5', 
28.25=>'19.1,43.2', 
28.5=>'19.5,43.9', 
28.75=>'19.8,44.5', 
29=>'20.2,45.2', 
29.25=>'20.6,45.8', 
29.5=>'20.9,46.5', 
29.75=>'21.3,47.1', 
30=>'21.6,47.8', 
30.25=>'22,48.5', 
30.5=>'22.4,49.1', 
30.75=>'22.7,49.8', 
31=>'23.1,50.4', 
31.25=>'23.5,51.1', 
31.5=>'23.8,51.8', 
31.75=>'24.2,52.4', 
32=>'24.6,53.1', 
32.25=>'24.9,53.7', 
32.5=>'25.3,54.4', 
32.75=>'25.6,55.1', 
33=>'26,55.7', 
33.25=>'26.4,56.4', 
33.5=>'27.1,56.4', 
33.75=>'27.9,56.4', 
34=>'28.6,56.4', 
34.25=>'29.3,56.5', 
34.5=>'30.1,56.5', 
34.75=>'30.8,56.5', 
35=>'31.5,56.5', 
35.25=>'32.3,56.6', 
35.5=>'33,56.6', 
35.75=>'33.8,56.6', 
36=>'34.5,56.6', 
36.25=>'34.3,55.9', 
36.5=>'34,55.2', 
36.75=>'33.8,54.5', 
37=>'33.5,53.8', 
37.25=>'33.3,53.1', 
37.5=>'33.1,52.4', 
37.75=>'32.8,51.7', 
38=>'32.6,51', 
38.25=>'32.3,50.3', 
38.5=>'32.1,49.6', 
38.75=>'31.9,48.9', 
39=>'31.6,48.2', 
39.25=>'31.4,47.5', 
39.5=>'31.1,46.8', 
39.75=>'30.9,46.1', 
40=>'30.7,45.4', 
40.25=>'30.4,44.7', 
40.5=>'30.2,44', 
40.75=>'29.9,43.3', 
41=>'29.7,42.6', 
41.25=>'29.5,41.9', 
41.5=>'29.2,41.2', 
41.75=>'29,40.5', 
42=>'28.7,39.8', 
42.25=>'28.5,39.1', 
42.5=>'28.3,38.4', 
42.75=>'29.1,38.4', 
43=>'29.9,38.5', 
43.25=>'30.7,38.6', 
43.5=>'31.5,38.6', 
43.75=>'32,39.2', 
44=>'32.5,39.7', 
44.25=>'33,40.2', 
44.5=>'33.5,40.7', 
44.75=>'34,41.3', 
45=>'34.6,40.8', 
45.25=>'35.3,40.4', 
45.5=>'35.9,40', 
45.75=>'36.6,39.6', 
46=>'37.2,39.2', 
46.25=>'37.9,38.8', 
46.5=>'38.6,38.8', 
46.75=>'39.4,38.9', 
47=>'40.2,38.9', 
47.25=>'41,39', 
47.5=>'41.7,39.1', 
47.75=>'42.5,39.1', 
48=>'43.1,39.5', 
48.25=>'43.8,39.8', 
48.5=>'44.4,40.2', 
48.75=>'45.1,40.6', 
49=>'45.7,40.9', 
49.25=>'46.4,41.3', 
49.5=>'47,41.6', 
49.75=>'47.6,41.3', 
50=>'48.3,41', 
50.25=>'48.9,40.7', 
50.5=>'49.6,40.3', 
50.75=>'50.2,40', 
51=>'50.9,39.7', 
51.25=>'51.5,39.4', 
51.5=>'52.2,39.3', 
51.75=>'52.9,39.3', 
52=>'53.6,39.3', 
52.25=>'54.4,39.2', 
52.5=>'55.1,39.2', 
52.75=>'55.8,39.2', 
53=>'56.5,39.1', 
53.25=>'57.1,39.6', 
53.5=>'57.7,40.1', 
53.75=>'58.3,40.6', 
54=>'58.9,41', 
54.25=>'59.5,41.5', 
54.5=>'59.7,42.2', 
54.75=>'59.9,42.8', 
55=>'60.2,43.5', 
55.25=>'60.4,44.1', 
55.5=>'60.3,44.8', 
55.75=>'60.1,45.6', 
56=>'60,46.3', 
56.25=>'59.9,47', 
56.5=>'59.8,47.7', 
56.75=>'59.7,48.4', 
57=>'59.5,49.1', 
57.25=>'59.4,49.9', 
57.5=>'59.3,50.6', 
57.75=>'59.2,51.3', 
58=>'59.1,52', 
58.25=>'59,52.7', 
58.5=>'58.8,53.4', 
58.75=>'58.7,54.2', 
59=>'58.6,54.9', 
59.25=>'58.5,55.6', 
59.5=>'58.4,56.3', 
59.75=>'58.2,57', 
60=>'58.1,57.8', 
60.25=>'58.8,57.8', 
60.5=>'59.5,57.8', 
60.75=>'60.3,57.9', 
61=>'61,57.9', 
61.25=>'61.7,58', 
61.5=>'62.4,58', 
61.75=>'63.1,58', 
62=>'63.8,58.1', 
62.25=>'64.5,58.1', 
62.5=>'64.5,57.4', 
62.75=>'64.6,56.6', 
63=>'64.6,55.9', 
63.25=>'64.6,55.2', 
63.5=>'64.6,54.4', 
63.75=>'64.7,53.7', 
64=>'64.7,52.9', 
64.25=>'64.7,52.2', 
64.5=>'64.7,51.5', 
64.75=>'64.8,50.7', 
65=>'64.8,50', 
65.25=>'64.8,49.3', 
65.5=>'64.8,48.5', 
65.75=>'64.9,47.8', 
66=>'64.9,47', 
66.25=>'64.9,46.3', 
66.5=>'64.9,45.6', 
66.75=>'65,44.8', 
67=>'65,44.1', 
67.25=>'65,43.3', 
67.5=>'65,42.6', 
67.75=>'65.1,41.9', 
68=>'65.1,41.1', 
68.25=>'65.1,40.4', 
68.5=>'65.9,40.2', 
68.75=>'66.6,40.1', 
69=>'67.4,39.9', 
69.25=>'68.1,39.8', 
69.5=>'68.9,39.6', 
69.75=>'69.6,39.5', 
70=>'69.5,40.2', 
70.25=>'69.5,41', 
70.5=>'69.4,41.7', 
70.75=>'69.3,42.4', 
71=>'69.2,43.2', 
71.25=>'69.2,43.9', 
71.5=>'69.1,44.6', 
71.75=>'69,45.4', 
72=>'68.9,46.1', 
72.25=>'68.9,46.8', 
72.5=>'68.8,47.6', 
72.75=>'68.7,48.3', 
73=>'68.6,49', 
73.25=>'68.6,49.8', 
73.5=>'68.5,50.5', 
73.75=>'68.4,51.2', 
74=>'68.3,52', 
74.25=>'68.3,52.7', 
74.5=>'68.2,53.4', 
74.75=>'68.1,54.2', 
75=>'68,54.9', 
75.25=>'68,55.6', 
75.5=>'67.9,56.4', 
75.75=>'68.4,55.8', 
76=>'68.9,55.3', 
76.25=>'69.3,54.8', 
76.5=>'69.8,54.2', 
76.75=>'70.3,53.7', 
77=>'70.8,53.2', 
77.25=>'71.3,52.6', 
77.5=>'71.8,52.1', 
77.75=>'72.3,51.6', 
78=>'72.8,51', 
78.25=>'73.3,50.5', 
78.5=>'73.8,49.9', 
78.75=>'74.3,49.4', 
79=>'74.7,48.9', 
79.25=>'75.5,48.7', 
79.5=>'76.3,48.4', 
79.75=>'77.1,48.2', 
80=>'77.9,48', 
80.25=>'78.6,47.8', 
80.5=>'79.1,48.5', 
80.75=>'79.5,49.2', 
81=>'80,49.9', 
81.25=>'79.9,50.6', 
81.5=>'79.8,51.4', 
81.75=>'79.7,52.2', 
82=>'79.6,52.9', 
82.25=>'79.5,53.7', 
82.5=>'79.4,54.5', 
82.75=>'79.3,55.2', 
83=>'79.2,56', 
83.25=>'79.1,56.8', 
83.5=>'79.6,56.2', 
83.75=>'80.1,55.7', 
84=>'80.6,55.1', 
84.25=>'81.1,54.6', 
84.5=>'81.5,54', 
84.75=>'82,53.5', 
85=>'82.5,52.9', 
85.25=>'83,52.4', 
85.5=>'83.5,51.8', 
85.75=>'84,51.3', 
86=>'84.4,50.7', 
86.25=>'84.9,50.2', 
86.5=>'85.4,49.6', 
86.75=>'85.9,49.1', 
87=>'86.4,48.5', 
87.25=>'86.8,48', 
87.5=>'87.3,47.4', 
87.75=>'87.8,46.9', 
88=>'88.3,46.3', 
88.25=>'88.8,45.8', 
88.5=>'89.3,45.3', 
88.75=>'89.7,44.7', 
89=>'90.2,44.2', 
89.25=>'90.7,43.6', 
89.5=>'91.2,43.1', 
89.75=>'91.7,42.5', 
90=>'92.2,42', 
90.25=>'92.6,41.4', 
90.5=>'93.1,40.9', 
90.75=>'93.8,41.1', 
91=>'94.5,41.2', 
91.25=>'95.2,41.4', 
91.5=>'95.8,41.6', 
91.75=>'96.5,41.8', 
92=>'96,42.3', 
92.25=>'95.5,42.8', 
92.5=>'95,43.4', 
92.75=>'94.5,43.9', 
93=>'94,44.5', 
93.25=>'93.5,45', 
93.5=>'92.9,45.5', 
93.75=>'92.4,46.1', 
94=>'91.9,46.6', 
94.25=>'91.4,47.2', 
94.5=>'90.9,47.7', 
94.75=>'90.4,48.3', 
95=>'89.9,48.8', 
95.25=>'89.4,49.3', 
95.5=>'88.9,49.9', 
95.75=>'88.4,50.4', 
96=>'87.9,51', 
96.25=>'87.3,51.5', 
96.5=>'86.8,52', 
96.75=>'86.3,52.6', 
97=>'85.8,53.1', 
97.25=>'85.3,53.7', 
97.5=>'84.8,54.2', 
97.75=>'84.3,54.7', 
98=>'83.8,55.3', 
98.25=>'83.3,55.8', 
98.5=>'82.8,56.4', 
98.75=>'82.3,56.9', 
99=>'81.8,57.5', 
99.25=>'81.2,58', 
99.5=>'80.6,58.4', 
99.75=>'79.9,58.8', 
100=>'79.3,59.2',

);

$sql = "SELECT IF( c.value = 'yes', 'true', 'false' ) AS game_status, c2.value AS RFHandleId, c3.value AS force_progress
		FROM config c
		LEFT JOIN config c2 ON c2.key = 'player'
		LEFT JOIN config c3 ON c3.key = 'progress'
		WHERE c.key = 'game_active'";
$game_info = $pdo->query($sql)->fetch();

//if($game_info['game_status'] == 'true' && $game_info['force_progress'] == 100)
if($game_info['force_progress'] == 100)
	$percent = 100;
else
{
	$sql = "SELECT * FROM player_progress WHERE player_guid='{$game_info['RFHandleId']}' ORDER BY `time` DESC LIMIT 1";
	foreach($pdo->query($sql) as $row)
	{
		$distance = 1000;
		$percent = 0;
		foreach($markers as $pc => $marker)
		{
			list($x, $y) = explode(',', $marker);
			$temp_distance = get_distance($row['x'], $row['y'], $x, $y);
			if($temp_distance < $distance)
			{
				$distance = $temp_distance;
				$percent = $pc;
			}
		}
	}
}

if(isset($_SESSION['previous_pc']) && $percent < ($_SESSION['previous_pc']-$negative_threshold) && $percent > 0)
	$percent = $_SESSION['previous_pc'];
$_SESSION['previous_pc'] = $percent;



$json_data = array('RFHandleId'=>$game_info['RFHandleId'], 'game_status'=>($game_info['game_status'] == 'true'), 'game_progress'=>$percent, 'game_time'=>time());

//header('Content-type: application/json');
echo json_encode($json_data);
exit;





function get_distance($x1, $y1, $x2, $y2)
{
	$side1 = abs($x1 - $x2);
	$side2 = abs($y1 - $y2);
	return sqrt($side1 * $side1 + $side2 * $side2);
}